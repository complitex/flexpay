<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd">

    <!-- Add hibernate statistics capabilities -->
    <!--<bean id="hibernateStatistics" class="org.hibernate.jmx.StatisticsService"-->
    <!--p:sessionFactory-ref="flexpaySessionFactory" />-->

    <!--
        this bean needs to be eagerly pre-instantiated in order for the exporting to occur;
        this means that it must not be marked as lazily initialized
      -->
<!--
    <bean id="exporter" class="org.springframework.jmx.export.MBeanExporter">
        <property name="beans">
            <map>
                <entry key="bean:name=hibernateStatistics${flexpay.module.name.common}" value-ref="hibernateStatistics" />
            </map>
        </property>
        <property name="assembler">
            <bean class="org.springframework.jmx.export.assembler.MethodNameBasedMBeanInfoAssembler">
                <property name="methodMappings">
                    <props>
                        <prop key="bean:name=hibernateStatsMBean">
                        </prop>
                    </props>
                </property>
            </bean>
        </property>
    </bean>
-->

    <!-- Create transaction manager  -->
    <bean id="transactionManager"
          class="org.springframework.orm.hibernate3.HibernateTransactionManager"
          p:dataSource-ref="dataSource"
          p:sessionFactory-ref="flexpaySessionFactory" />

    <!--
        Indicates that transaction
        configuration is defined by Java5 annotations on bean classes, and
        that proxies are automatically to be created for the relevant
        annotated beans.

        Transaction semantics such as propagation settings, the isolation level,
        the rollback rules, etc are all defined in the annotation metadata.
    -->
    <tx:annotation-driven transaction-manager="transactionManager" />

    <bean id="hibernateTemplate"
          class="org.springframework.orm.hibernate3.HibernateTemplate"
          p:sessionFactory-ref="flexpaySessionFactory" />

    <bean id="jdbcTemplate"
          class="org.springframework.jdbc.core.JdbcTemplate">
        <constructor-arg ref="dataSource" />
    </bean>

    <!--  Dao Layer generic config-->
    <bean id="namingStrategy"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean"
          p:staticField="${namingStrategy.staticField}" />

    <bean id="extendedFinderNamingStrategy"
          class="org.flexpay.common.dao.finder.impl.ExtendedFinderNamingStrategy" />

    <bean id="finderIntroductionAdvisor"
          class="org.flexpay.common.dao.finder.impl.FinderIntroductionAdvisor" />

    <bean id="abstractDaoTarget"
          class="org.flexpay.common.dao.impl.GenericDaoHibernateImpl"
          abstract="true"
          p:hibernateTemplate-ref="hibernateTemplate"
          p:namingStrategy-ref="extendedFinderNamingStrategy" />

    <bean id="abstractDao"
          abstract="true"
          class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="interceptorNames">
            <list>
                <value>finderIntroductionAdvisor</value>
            </list>
        </property>
    </bean>

    <bean name="lockManager"
          class="org.flexpay.common.locking.LockManager"
          destroy-method="releaseAll"
          p:hibernateTemplate-ref="hibernateTemplate" />

    <bean id="jbpmObjectFactory"
          class="org.flexpay.common.process.FlexPayJBPMObjectFactory"
          p:configuration="WEB-INF/common/configs/jbpm/jbpm.cfg.xml" />

    <bean id="jbpmConfiguration"
          class="org.springmodules.workflow.jbpm31.LocalJbpmConfigurationFactoryBean"
          scope="singleton"
          p:sessionFactory-ref="flexpaySessionFactory"
          p:objectFactory-ref="jbpmObjectFactory" />

    <bean name="jobManager"
          class="org.flexpay.common.process.job.JobManager"
          factory-method="getInstance"
          destroy-method="unload"
          p:processManager-ref="processManager"
          p:maximumRunningJobs="${job_manager.maximumRunningJobs}" />

    <bean name="processManager"
          class="org.flexpay.common.process.ProcessManagerImpl"
          destroy-method="stop"
          init-method="start"
          factory-method="getInstance"
          p:processDao-ref="processDao"
          p:jbpmConfiguration-ref="jbpmConfiguration"
          p:rescanFrequency="${process_manager.rescanFrequency}"
          p:taskRepeatLimit="${process_manager.startTaskLimit}">
        <property name="definitionPaths">
            <list>
                <value>WEB-INF/common/process</value>
            </list>
        </property>
    </bean>

    <bean name="fooProcessManager"
          class="org.flexpay.common.process.FooProcessManagerImpl"
          destroy-method="stop"
          init-method="start"
          factory-method="getInstance"
          autowire-candidate="false"
          p:jbpmConfiguration-ref="jbpmConfiguration"
          p:rescanFrequency="${process_manager.rescanFrequency}"
          p:taskRepeatLimit="${process_manager.startTaskLimit}" />

</beans>
