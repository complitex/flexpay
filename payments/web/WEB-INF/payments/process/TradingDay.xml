<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="urn:jbpm.org:jpdl-3.2" name="TradingDay"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="urn:jbpm.org:jpdl-3.2 http://docs.jboss.org/jbpm/xsd/jpdl-3.2.xsd">

    <swimlane name="Accounter">
        <assignment class="org.flexpay.payments.process.handlers.AccounterAssignmentHandler"/>
    </swimlane>

<!--
    <swimlane name="PaymentCollector">
        <assignment actor-id="generalPaymentCollector"/>
    </swimlane>
-->

    <swimlane name="JobManager">
        <assignment class="org.flexpay.common.process.JobManagerAssignmentHandler"/>
    </swimlane>

    <start-state name="Start">
        <description>
            Старт опердня
        </description>
        <transition to="MarkPaymentPointForClosing" name="start"/>
    </start-state>

    <task-node name="MarkPaymentPointForClosing">
        <description>
            ожидаем от главного кассира пометки окончания опердня
        </description>
        <event type="node-enter">
            <script>
                <variable mapped-name="processStatus" access="write" name="PROCESS_STATUS"/>
                <expression>
                    processStatus = "opened";
                </expression>
            </script>
        </event>
        <task name="CloseTradingDay" swimlane="Accounter">
            <timer duedate="10 seconds" transition="generateEndOperationDayRegistryJob">
                <script>
                    <variable mapped-name="autoMode" access="write" name="AUTO_MODE"/>
                    <expression>
                        autoMode = "true";
                    </expression>
                </script>
            </timer>
        </task>
        <!--
        <task name="CloseTradingDay" swimlane="PaymentCollector">
            <timer duedate="10 business seconds" transition="generateEndOperationDayRegistryJob">
                <script>
                    <variable mapped-name="autoMode" access="write" name="AUTO_MODE"/>
                    <expression>
                        autoMode = "true";
                    </expression>
                </script>
            </timer>
        </task>
        -->
        <transition to="generateEndOperationDayRegistryJob" name="tradingDay.mark_for_closing"/>
    </task-node>


    <task-node name="generateEndOperationDayRegistryJob">
        <description>
            генерация реестра типа 12
        </description>
        <event type="node-enter">
            <script>
                <variable mapped-name="processStatus" access="write" name="PROCESS_STATUS"/>
                <expression>
                    processStatus = "processing";
                </expression>
            </script>
        </event>
        <task swimlane="JobManager"/>
        <transition to="sendRegistryJob" name="next"/>
    </task-node>


    <task-node name="sendRegistryJob">
        <description>
            отправляем на указанный в ППП емейл с вложенным файлом сформированного реестра
        </description>
        <task swimlane="JobManager" blocking="yes" />
        <transition to="WaitForApprove" name="next"/>
    </task-node>


    <task-node name="WaitForApprove">
        <description>
            ожидаем от бухгалтера действия
        </description>
        <event type="node-enter">
            <script>
                <variable mapped-name="processStatus" access="write" name="PROCESS_STATUS"/>
                <expression>
                    processStatus = "opened";
                </expression>
            </script>
        </event>
        <event type="node-leave">
            <script>
                <variable mapped-name="processStatus" access="write" name="PROCESS_STATUS"/>
                <expression>
                    processStatus = "closed";
                </expression>
            </script>
        </event>
        <timer duedate="1 business day" transition="end-state"/>
        <task name="Aproove" swimlane="Accounter"/>
        <transition to="MarkPaymentPointForClosing" name="tradingDay.close_denied"/>
        <transition to="end-state" name="tradingDay.close_approved"/>
    </task-node>

    <end-state name="end-state"/>

</process-definition>