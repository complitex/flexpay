<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
		"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
		"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping package="org.flexpay.eirc.persistence">

	<class name="Consumer" table="eirc_consumers_tbl">
		<id name="id" column="id">
			<generator class="native"/>
		</id>
		<property name="status" column="status" not-null="true"/>
		<property name="externalAccountNumber" not-null="true"
				  column="external_account_number"/>
		<many-to-one name="service" foreign-key="FK_eirc_consumer_service" class="Service">
			<column name="service_id" not-null="true">
				<comment>Service reference</comment>
			</column>
		</many-to-one>
		<many-to-one name="responsiblePerson" foreign-key="FK_eirc_consumer_responsible_person"
					 class="org.flexpay.ab.persistence.Person">
			<column name="person_id" not-null="true">
				<comment>Responsible person reference</comment>
			</column>
		</many-to-one>
		<many-to-one name="apartment" foreign-key="FK_eirc_consumer_apartment"
					 class="org.flexpay.ab.persistence.Apartment">
			<column name="apartment_id" not-null="true">
				<comment>Apartment reference</comment>
			</column>
		</many-to-one>
		<many-to-one name="eircAccount" foreign-key="FK_eirc_consumer_eirc_account"
					 class="org.flexpay.eirc.persistence.EircAccount">
			<column name="eirc_account_id" not-null="true">
				<comment>EIRC account reference</comment>
			</column>
		</many-to-one>
		<property name="beginDate">
			<column name="begin_date" not-null="true">
				<comment>Consumer begin date</comment>
			</column>
		</property>
		<property name="endDate">
			<column name="end_date" not-null="true">
				<comment>Consumer end date</comment>
			</column>
		</property>
	</class>

	<class name="AccountRecordType" table="eirc_account_record_types_tbl"
		   optimistic-lock="version">
		<id name="id" column="id">
			<generator class="native"/>
		</id>
		<property name="description" not-null="true"/>
		<property name="typeId" not-null="true" column="type_enum_id"/>
	</class>

	<class name="AccountRecord" table="eirc_account_records_tbl"
		   optimistic-lock="version">
		<id name="id" column="id">
			<generator class="native"/>
		</id>
		<many-to-one name="consumer" foreign-key="FK_eirc_account_record_consumer" class="Consumer">
			<column name="consumer_id" not-null="true">
				<comment>Consumer reference</comment>
			</column>
		</many-to-one>
		<many-to-one name="organisation" foreign-key="FK_eirc_account_record_organisation" class="Organisation">
			<column name="organisation_id" not-null="false">
				<comment>Reference to organisation performed operation</comment>
			</column>
		</many-to-one>
		<property name="operationDate" column="operation_date" not-null="true"
				  type="timestamp"/>
		<property name="amount" type="big_decimal" not-null="true"/>
		<many-to-one name="recordType" foreign-key="FK_eirc_account_record_record_type" class="AccountRecordType">
			<column name="record_type_id" not-null="true">
				<comment>Account record type reference</comment>
			</column>
		</many-to-one>
		<many-to-one name="sourceRegistryRecord" foreign-key="FK_eirc_account_record_registry_record" class="SpRegistryRecord">
			<column name="source_registry_record_id" not-null="false">
				<comment>Registry record reference</comment>
			</column>
		</many-to-one>
	</class>

	<class name="EircAccount" table="eirc_eirc_accounts_tbl">
		<comment>EIRC Personal accounts table</comment>
		<id name="id" column="id">
			<generator class="native"/>
		</id>
		<version name="version" access="field">
			<column name="version">
				<comment>Optimistic lock version</comment>
			</column>
		</version>
		<property name="status" column="status" not-null="true"/>
		<property name="accountNumber">
			<column name="account_number" not-null="true">
				<comment>EIRC account number</comment>
			</column>
		</property>
		<many-to-one name="apartment" foreign-key="FK_eirc_eirc_accounts_apartment_id"
					 class="org.flexpay.ab.persistence.Apartment">
			<column name="apartment_id" not-null="true">
				<comment>Apartment reference</comment>
			</column>
		</many-to-one>
		<many-to-one name="person" foreign-key="FK_eirc_eirc_accounts_person_id"
					 class="org.flexpay.ab.persistence.Person">
			<column name="person_id" not-null="true">
				<comment>Responsible person reference</comment>
			</column>
		</many-to-one>
		<set name="consumers" inverse="true" cascade="all-delete-orphan">
			<key column="eirc_account_id" not-null="true"/>
			<one-to-many class="Consumer"/>
		</set>
		
	</class>

	<query name="AccountRecord.findRegisteredRecords.count">
		select count(*) from AccountRecord
		where organisation.id=? and consumer.id=? and operationDate=? and amount=? and
		recordType.id=?
	</query>

	<query name="AccountRecord.findRegisteredRecords">
		from AccountRecord
		where organisation.id=? and consumer.id=? and operationDate=? and amount=? and
		recordType.id=?
	</query>

	<query name="AccountRecord.findBalanceForDate">
		<![CDATA[
		SELECT SUM(record.amount)
		FROM AccountRecord record
		WHERE record.consumer.id=? AND record.operationDate<=?
	]]>
	</query>

	<query name="AccountRecord.findCalculateServiceAmount">
		SELECT record.consumer.id, sum(record.amount)
		FROM AccountRecord record
		WHERE record.consumer.responsiblePerson.id=? AND
		record.consumer.apartment.id=? AND
		record.operationDate <![CDATA[<]]> ?
		GROUP BY record.consumer.id
	</query>

	<query name="Consumer.findConsumers.count">
		select count(*)
		from Consumer
		where responsiblePerson.id = ?
		and service.id = ?
		and externalAccountNumber = ?
		and apartment.id = ?
	</query>

	<query name="Consumer.findConsumers">
		from Consumer
		where responsiblePerson.id = ?
		and service.id = ?
		and externalAccountNumber = ?
		and apartment.id = ?
	</query>

	<query name="EircAccount.findByPersonAndApartment">
		from EircAccount where person.id=? and apartment.id=? and status=0
	</query>
	
	<query name="EircAccount.findObjects">
		from EircAccount where status=0
	</query>
	<query name="EircAccount.findObjects.count">
		select count(*) from EircAccount a where a.status=0
	</query>
	
	
</hibernate-mapping>
